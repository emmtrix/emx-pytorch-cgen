{{ signature }}
    for (int64_t n = 0; n < {{ batch }}; ++n) {
        for (int64_t c = 0; c < {{ channels }}; ++c) {
            for (int64_t ih = 0; ih < {{ in_h }}; ++ih) {
                for (int64_t iw = 0; iw < {{ in_w }}; ++iw) {
                    out[n][c][ih][iw] = 0;
                }
            }
            for (int64_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (int64_t ow = 0; ow < {{ out_w }}; ++ow) {
                    int64_t in_h_base = oh * {{ stride_h }} - {{ pad_h }};
                    int64_t in_w_base = ow * {{ stride_w }} - {{ pad_w }};
                    int64_t count = 0;
                    for (int64_t kh = 0; kh < {{ k_h }}; ++kh) {
                        int64_t in_h_idx = in_h_base + kh;
                        if (in_h_idx < 0 || in_h_idx >= {{ in_h }}) {
                            continue;
                        }
                        for (int64_t kw = 0; kw < {{ k_w }}; ++kw) {
                            int64_t in_w_idx = in_w_base + kw;
                            if (in_w_idx < 0 || in_w_idx >= {{ in_w }}) {
                                continue;
                            }
                            count += 1;
                        }
                    }
                    {% if has_divisor_override %}
                    int64_t divisor = {{ divisor_override }};
                    {% elif count_include_pad %}
                    int64_t divisor = {{ k_h }} * {{ k_w }};
                    {% else %}
                    int64_t divisor = count;
                    {% endif %}
                    {{ c_type }} grad = grad_output[n][c][oh][ow] / ({{ c_type }})divisor;
                    for (int64_t kh = 0; kh < {{ k_h }}; ++kh) {
                        int64_t in_h_idx = in_h_base + kh;
                        if (in_h_idx < 0 || in_h_idx >= {{ in_h }}) {
                            continue;
                        }
                        for (int64_t kw = 0; kw < {{ k_w }}; ++kw) {
                            int64_t in_w_idx = in_w_base + kw;
                            if (in_w_idx < 0 || in_w_idx >= {{ in_w }}) {
                                continue;
                            }
                            out[n][c][in_h_idx][in_w_idx] += grad;
                        }
                    }
                }
            }
        }
    }
}
